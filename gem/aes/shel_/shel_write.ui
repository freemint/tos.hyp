!iflang [english]

!begin_node shel_write

(!begin_liste) [Availability]

!item [Name:]
ØShell writeÆ - startet eine andere Applikation.

!item [Opcode:]
121

!item [Syntax:]
int16_t shel_write ( int16_t sh_wdoex, int16_t sh_wisgr, int16_t sh_wiscr,
                  int8_t *sh_wpcmd, int8_t *sh_wptail );

!item [Description:]
Die Funktion ermîglicht das Starten eines anderen Programms. Ab AES-Version
4.0 wurde diese Funktion stark erweitert. So lassen sich nun auch Aufgaben
wie ein Herunterfahren des Systems (Shutdown), ein Auflîsungswechsel,
AES-Broadcasting und andere Dinge realisieren.

Der Parameter (!I)sh_wdoex(!i) bestimmt die auszufÅhrende Aktion, die
restlichen Parameter sind im wesentlichen von (!I)sh_wdoex(!i) abhÑngig. Es
gilt:

!begin_xlist !short [sh_wdoe]
!item [sh_wdoex]
Bedeutung
!item [~]
~
!item [0]
(!B)Applikation starten(!b)
(!nl)
Der Wert des Parameters (!I)sh_wisgr(!i) (Starten im Grafikmodus, ja oder
nein) wird automatisch vom (!nolink [AES]) gesetzt, indem die File-Extension mit den
Inhalten der AES-Environmentvariablen GEMEXT, TOSEXT und ACCEXT verglichen
wird.
!item [1]
(!B)Applikation im GEM/TOS Modus starten(!b)
(!nl)
Der Parameter (!I)sh_wisgr(!i) legt dabei den Modus fest, in dem das
Programm gestartet werden soll. Es gilt:
!begin_xlist !short [sh_wisgr = 0:]
!item [sh_wisgr = 0:]
als TOS-Programm starten
!item [sh_wisgr = 1:]
als (!nolink [GEM])-Programm starten
!end_xlist
!item [2]
(!B)reserviert(!b)
!item [3]
(!B)Accessorie starten(!b)
(!nl)
Ein Programm soll als Accessorie gestartet werden.
!end_xlist

In den Parametern (!I)sh_wpcmd(!i) und (!I)sh_wptail(!i) sind dabei der Name
des zu startenden Programms bzw. ein Zeiger auf die Kommandozeile zu
Åbergeben. Als Default-Verzeichnis wird dabei das Verzeichnis gewÑhlt, in
dem sich das zu startende Programm befindet (Ausnahme: erweiterter Modus mit
gesetztem Bit-10, s.u.).

Die Funktion liefert die (!nolink [AES])-ID des gestarteten Prozesses zurÅck. Ein Wert
von 0 zeigt in diesem Zusammenhang einen Fehler an. öber den Parameter
(!I)sh_wiscr(!i) kann spezifiziert werden, ob (!B)Parameter per ARGV(!b) an
das gestartete Programm Åbergeben werden sollen. Es gilt:

sh_wiscr = 0: ARGV-Verfahren nicht benutzen (!nl)
sh_wiscr = 1: (!nolink [ARGV-Verfahren]) benutzen

!label Paralleles Starten von Programmen
Unter MagiC kann hingegen angegeben werden, ob ein Programm im
(!B)Single-Modus(!b) (oder parallel) gestartet werden soll. Es gilt:

sh_wiscr = 100  (!B)(Programm parallel ausfÅhren)(!b)
(!nl)
Die neue Applikation erbt alle Standardpfade und -dateien von der aktuellen
Applikation. Ein Fehlercode wird nur dann zurÅckgeliefert, falls bereits
beim Einrichten ein Speicherplatzmangel aufgetreten ist; eine Benachrichtung
beim Beenden der neuen Applikation (Death-of-Child) existiert nicht (*).

!label Single-Modus
sh_wiscr = 101  (!B)(Programm im Single-Modus ausfÅhren)(!b)
(!nl)
Dieser Modus entspricht (!I)sh_wiscr(!i) mit dem Wert 1, mit der Ausnahme,
daû vor Aufruf des Programms alle Applikationen auûer denjenigen mit ID-0
und ID-1 (SCRENMGR) eingefroren werden. Die Programme werden nach Beendigung
des Programms wieder aufgetaut, wenn dieses nicht seinerseits einen neuen
shel_write-Aufruf mit Singlemode Charakter ausgefÅhrt hat. (!B)Das genaue
Kochrezept fÅr den Single-Modus lautet:(!b)

!begin_itemize !short
!item Ensure that I am application #0 (i.e. ap_id == 0).
!item Set paths and drive for the new program.
!item shel_write (TRUE, sh_wisgr, 101, sh_wpcmd, sh_wptail);
!item All important settings to temporary file or shell-buffer.
!item appl_exit, v_clsvwk, Pterm0 execute.
!end_itemize

Beachtet werden sollte noch, daû ab (!nolink [MagiC])-2 im Single-Modus die aktuellen
Pfade des Aufrufers an den Parent und damit an das neue Programm Åbergeben
werden. Die Pfade des Aufrufers sind anschlieûend zerstîrt, was aber
unkritisch ist, da dieser auf den shel_write i.a. ein Pterm folgen lÑût (*).

Im (!B)erweiterten Modus(!b), kann Åber spezielle Bits des Parameters
(!I)sh_wdoex(!i) das Starten von Programmen weiter spezifiziert werden. Das
Low-Byte bleibt dabei unangetastet, und fÅr das High-Byte gilt:

!begin_table [c|l]
sh_wdoex Bit !! Bedeutung
!hline
 8 !! Wert von Psetlimit
 9 !! Wert von Prenice
10 !! Default-Verzeichnis
11 !! Environment-String
12 !! reserves
13 !! reserves
14 !! reserves
15 !! reserves
!end_table

In diesem erweiterten Modus wird der Parameter (!I)sh_wpcmd(!i) als Zeiger
auf eine Menge von 32bit (Long-)Werten aufgefaût. Jedem der o.g. Bits ist
dabei ein Long-Wert zugewiesen, der gÅltig ist, wenn das entsprechende Bit
gesetzt ist. Die Menge der 32bit Werte ist folgendermaûen belegt:

!begin_xlist !short [Elemen]
!item [Element]
Bedeutung
!item [~]
~
!item [[0!]]
Zeiger auf den Namen des Programms
!item [[1!]]
Wert von Psetlimit (Bit-8)
!item [[2!]]
Wert von Prenice   (Bit-9)
!item [[3!]]
Zeiger auf das Default-Verzeichnis.
(!nl)
Ein Nullzeiger bedeutet in diesem Zusammenhang, daû als Default-Verzeichnis
dasjenige gewÑhlt wird, indem sich das zu startende Programm befindet.
(Bit-10)
!item [[4!]]
Zeiger auf das Environment der Applikation (Bit-11)
!end_xlist

(!B)Hinweis:(!b) Die Elemente [1],[2] und [3] werden bis (!nolink [MagiC])-3 ignoriert;
Element [1] wird jedoch ab MagiC-4 unterstÅtzt. Das Default-Verzeichnis wird
unter (!nolink [MagiC]) viel einfacher gesetzt, denn das neue Programm erbt alle Pfade
auf allen Laufwerken vom aufrufenden Programm. (!nl)
In Geneva can only set Bit 8.

(!B)In neueren (!nolink [AES])-Versionen stehen darÅber hinaus die folgenden Modi zur
VerfÅgung(!b).

!begin_xlist [sh_wdoe]
!item [sh_wdoex]
Meaning
!item [~]
~
!label Shutdown Modus
!item [4]
(!B)Shutdown-Modus setzen(!b)
(!nl)
Dieses Kommando versetzt das System in AbhÑngigkeit des Parameters
(!I)sh_wiscr(!i) in den Normal bzw. Shutdown Modus. Es gilt:

!begin_xlist !short [sh_wisc]
!item [sh_wiscr]
Bedeutung
!item [~]
~
!label Shutdown abbrechen
!item [0]
(!B)Shutdown Sequenz abbrechen(!b)
(!nl)
Ein begonnener Shutdown kann nur von dem Prozess beendet werden, der diese
Sequenz auch gestartet hat.
!label Shutdown, partieller
!item [1]
(!B)Partieller Shutdown(!b)
(!nl)
Mit Ausnahme des Aufrufers werden alle Applikationen vom (!nolink [AES]) daraufhin
ÅberprÅft, ob sie die Meldung AP_TERM verstehen. Wenn dies der Fall ist,
schickt das (!nolink [AES]) die Meldungen (!nolink [AP_TERM]) bzw. AC_CLOSE an die
Programme bzw. Accessories. Der Aufrufer erhÑlt keine dieser Meldungen.
!label Shutdown, vollstÑndiger
!item [2]
(!B)VollstÑndiger Shutdown(!b)
(!nl)
Mit Ausnahme des Aufrufers werden alle Applikationen und Accessories vom
AES daraufhin ÅberprÅft, ob sie die Meldung AP_TERM verstehen. Wenn dies der
Fall ist, schickt das (!nolink [AES]) die Meldungen (!nolink [AP_TERM]) bzw.
(!nolink [AC_CLOSE]) an die
Programme bzw. Accessories. Accessories erhalten die (!nolink [AP_TERM]) Nachricht
zusÑtzlich nach Erhalt der (!nolink [AC_CLOSE]) Message. Der Aufrufer erhÑlt keine
dieser Meldungen.
!end_xlist

In N.AES gibt es einen erweiterten Aufruf: (!nl)
shel_write(4, shutart, 0, &ignorant, NULL);

(!I)ignorant(!i) ist hierbei ein Integer, dessen Adresse als vierter Parameter des
shel_write-Aufrufs Åbergeben wird. Im Fehlerfall ist der RÅckgabewert der
Funktion shel_write wie bisher 0, zusÑtzlich wird jedoch in (!I)ignorant(!i) die Applikations-ID
(apid) der Applikation hinterlegt, die AP_TERM nicht verstanden hat
bzw. -1, wenn bereits ein Shutdown lÑuft oder -2, wenn ungÅltige Parameter
Åbergeben wurden.

!label Auflîsungswechsel
!item [5]
(!B)Auflîsungswechsel(!b)
(!nl)
Die Applikation fordert das (!nolink [AES]) auf, die Auflîsung zu wechseln. Falls das
(!nolink [AES]) dem Wechsel zustimmt, versucht es, das System herunterzufahren
(Shutdown). Die aktiven Applikationen kînnen sich nun entweder beenden,
oder durch eine AP_TFAIL Nachricht dem AES mitteilen, daû sie hierzu nicht
in der Lage sind. Die Parameter (!I)sh_wisgr(!i) und (!I)sh_wiscr(!i) sind
dabei voneinander abhÑngig. Es gilt:

!begin_xlist !short [sh_wisc]
!item [sh_wiscr]
Bedeutung
!item [~]
~
!item [0]
Der Parameter (!I)sh_wisgr(!i) ist die ID des physikalischen GerÑtes, auf
dem der Open-Workstation Aufruf des VDI ausgefÅhrt wird. Die aktuelle
physikalische GerÑtenummer kann wie Åblich per Getrez() + 2 ermittelt
werden; es stehen folgende Werte zur VerfÅgung:
!begin_table [l l l r]
2 !! = !! ST-Low    !!  (320*200)
3 !! = !! ST-Medium !!  (640*200)
4 !! = !! ST-High   !!  (640*400)
6 !! = !! TT-Medium !!  (640*480)
8 !! = !! TT-High   !! (1280*960)
9 !! = !! TT-Low    !!  (320*480)
!end_table
!item [1]
Der Parameter (!I)sh_wisgr(!i) ist das int16_t fÅr den Video-Modus des Falcon.
!item [>2]
fÅr zukÅnftige Zwecke reserviert
!end_xlist

In N.AES gibt es einen erweiterten Aufruf: (!nl)
shel_write(5, vmode, falconflag, &ignorant, NULL); (!nl)
Da ein Auflîsungswechsel intern zunÑchst immer einen vollstÑndigen Shutdown
startet, kann es auch hier geschehen, daû nicht alle Anwendungen AP_TERM
verstehen und der Auflîsungswechsel somit frÅhzeitig fehlschlÑgt. Analog zur
obigen Modus-4-Erweiterung wird auch hier die Applikations-ID eines
VerstÑndnislosen in (!I)ignorant(!i) hinterlegt, eine -1, wenn bereits ein (!nolink [Shutdown])
lÑuft oder -2, wenn fehlerhafte Parameter (z.B. unerlaubte Auflîsungen)
Åbergeben wurden.

!item [6]
(!B)unknown(!b)

!label Broadcasting des AES
!label AES-Broadcasting
!item [7]
(!B)AES-Broadcasting(!b)
(!nl)
Die Applikation mîchte eine Nachricht an alle anderen im System vorhandenen
Applikationen schicken. Als EmpfÑnger ausgenommen sind nur das AES, der
Screen-Manager, sowie der Absender der Nachricht selbst.

Der Parameter (!I)sh_wpcmd(!i) ist ein Zeiger auf einen 16 Bytes groûen
Nachrichtenpuffer, der die zu sendenden Daten enthÑlt.

!label AES-Environment manipulieren
!label Environment des AES manipulieren
!item [8]
(!B)Manipulation des (!nolink [AES])-Environments(!b)
(!nl)
Dieses Kommando erlaubt die Modifikation des AES-Environments. Der Parameter
(!I)sh_wisgr(!i) beschreibt die gewÅnschte Aktion. Es gilt:

!begin_xlist !short [sh_wisg]
!item [sh_wisgr]
Bedeutung
!item [~]
~
!item [0]
(!B)Grîûe des Environment-Puffers erfragen(!b). Diese wird als
Funktionsergebnis zurÅckgeliefert.
!item [1]
(!B)EinfÅgen/Entfernen von Strings(!b). Der Parameter (!I)sh_wpcmd(!i) ist
ein Zeiger auf den Environment-String. Die Syntax zum EinfÅgen bzw.
Entfernen lautet 'NEW=STRING\0' bzw. 'NEW=\0'.
!item [2]
(!B)Inhalt des Environment-Puffers kopieren(!b). Der Parameter
(!I)sh_wpcmd(!i) ist ein Zeiger auf den aufnehmenden Puffer, der eine Grîûe
von (!I)sh_wiscr(!i) Bytes besitzt. Die Funktion liefert die Anzahl der
Bytes zurÅck, die nicht kopiert werden konnten.
!end_xlist

!item [9]
(!B)UnterstÅtzte Nachrichten anzeigen(!b)
(!nl)
Die Applikation teilt dem (!nolink [AES]) mit, welche (neuen) Nachrichten verstanden
werden. Dies geschieht Åber gesetzte Bits des Parameters (!I)sh_wisgr(!i).
!label NM_INHIBIT_HIDE
!begin_xlist !short [Bit 0:]
!item [Bit 0:]
AP_TERM
!item [Bit 1:]
NM_INHIBIT_HIDE (since XaAES 2005-01-16) (!nl)
Prevent the application to be hidden. Usefull for "desktop" utilities
like taskbar.
!end_xlist
Alle anderen Bits (2-15) sind z.Zt. nicht definiert.

!item [10]
(!B)Nachricht an (!nolink [AES]) senden(!b)
(!nl)
Die Applikation will eine Nachricht an das (!nolink [AES]) schicken. Der Parameter
(!I)sh_wpcmd(!i) ist ein Zeiger auf den 16 Bytes groûen Nachrichtenpuffer.

!begin_description
!item [Geneva]
A program can cause a windowed dialog to scroll by sending a WM_ARROWED
message to Geneva. Example:
!begin_verbatim
  int16_t msg[8];

  msg[0] = WM_ARROWED;
  msg[3] = window_handle;
  msg[4] = WA_UPPAGE;
  shel_write( SHW_SENDTOAES, 0, 0, (int8_t *)msg, 0L );
!end_verbatim
!end_description

!label Threads, Erzeugen von
!item [20]
(!B)Neuen Thread erzeugen(!b)
(!nl)
Mit diesem Opcode kann die Applikation einen neuen Thread erzeugen. Dabei
gilt:

!begin_xlist !short [Paramete]
!item [Parameter]
Bedeutung
!item [~]
~
!item [sh_wisgr]
!begin_xlist !short [0 =]
!item [0 =]
Starte Programm im VT52 Fenster der Applikation, falls eines geîffnet ist.
!item [1 =]
îffne kein neues Fenster
!item [2 =]
îffne neues VT52-Fenster
!end_xlist
!item [sh_wiscr]
0
!item [sh_wpcmd]
Zeiger auf THREADINFO-Struktur.
!item [sh_wptail]
Parameter vom Typ (void *) fÅr die Thread-Funktion.
!end_xlist

Bei einem erfolgreichen Aufruf wird als Ergebnis die Applikations-ID des
neuen Threads zurÅckgeliefert (*).

!label Threads, Beenden von
!item [21]
(!B)Thread beenden(!b)
(!nl)
Mit diesem Opcode kann sich ein Thread selbst beenden. Dazu setzt man die
Parameter (!I)sh_wisgr(!i) (!I)sh_wiscr(!i) und (!I)sh_wptail(!i) auf die
Werte 0 bzw. NULL; Åber (!I)sh_wpcmd(!i) kann ein zurÅckzuliefernder
Fehlercode angegeben werden.

Normalerweise ist ein AusfÅhren dieser Funktion nicht notwendig, da sich der
Thread automatisch mit dem Ende seiner Prozedur (d.h. mit dem CPU-Befehl
RTS) selbst beendet. (!B)Wichtig:(!b) Wenn der Thread einen Pexec-Aufruf
durchgefÅhrt hat, so muss zuerst der laufende Prozess per Pterm beendet
werden, bevor sich der Thread beenden kann (*).

!item [22]
(!B)Thread terminieren(!b)
(!nl)
Mit diesem Opcode kann ein Thread auch vom Hauptprogramm beendet werden.
Dazu Åbergibt man im Parameter (!I)sh_wiscr(!i) die Applikations-ID des
Thread, und setzt die Åbrigen Parameter auf den Wert 0 bzw. NULL.

Normalerweise ist diese Funktion nicht notwendig, da mit dem Beenden des
Hauptprogramms automatisch auch alle zugehîrigen Threads beendet werden. Die
Funktion wurde erfolgreich ausgefÅhrt, wenn als Ergebnis der Wert 1
zurÅckgeliefert wird. Zu beachten ist jedoch, daû fÅr den Fall, daû der
Thread inzwischen ein Pexec ausgefÅhrt hat, nur dieses Programm per Pterm
(EBREAK) beendet wird; der Thread selbst ist erst dann beendet, wenn der
Aufrufer ein THR_EXIT empfangen hat (*).

!label XSHW_RUNANY
!item [224]
(!B)Run an application(!b) (Geneva since Update 004)
(!nl)
Run an application, letting Geneva determine the
type. This is identical to mode 0, except that the XSHD_FLAGS bit
of (!I)sw_doex(!i) can also be set (see below).

!label XSHW_RUNAPP
!item [225]
(!B)Run an application(!b) (Geneva since Update 004)
(!nl)
This is identical to mode 1,
except that the XSHD_FLAGS bit of (!I)sw_doex(!i) can also be set.

!label XSHW_RUNACC
!item [227]
(!B)Run a desk accessory.(!b) (Geneva since Update 004)
(!nl)
This is identical to mode 3, except that the XSHD_FLAGS bit of
(!I)sw_doex(!i) can also be set.

When XSHD_FLAGS (1<<15) is added to the (!I)sw_doex(!i), this means that the
last longword of the SHWRCMD passed in the (!I)sh_wpcmd(!i) parameter contains
the Geneva program flags to use when executing the application. (!nl)
It is strongly recommended that a program using XSHD_FLAGS inquire the
current flags for the application and only change the ones it needs to
change, rather than making most of the flags zero or some other random
value. See the x_appl_flags section, below, for an example.

!end_xlist

(!B)Hinweis:(!b) Ab MagiC-3 stehen die folgenden Besonderheiten zur
VerfÅgung:

!begin_itemize
!item Wird in (!I)sh_wptail(!i) eine Zeichenkette Åbergeben, die mit dem
      Wert 255 beginnt und mit '\0' abgeschlossen ist, wird die tatsÑchliche
      LÑnge der Kommandozeile vom AES bestimmt und in ganzer LÑnge ans DOS
      weitergereicht. Das DOS konstruiert hieraus einen ARGV-Parameter im
      Environment. Ist die Kommandozeile kÅrzer als 127 Bytes, wird sie Åber
      Basepage und per shel_read Åbergeben, ansonsten besteht sie nur aus
      dem Byte mit dem Wert 127.
!item Wird in (!I)sh_wptail(!i) eine Zeichenkette Åbergeben, die mit dem
      Wert 254 beginnt, erwartet das AES dahinter die Zeichenkette
      "ARGV=irgendwas" und eine durch '\0' getrennte und durch "\0\0"
      abgeschlossene Liste von Parametern. Diese wird vollstÑndig dem DOS
      Åbergeben, das daraus einen ARGV-Parameter konstruiert. Ist die
      Kommandozeile kÅrzer als 127 Bytes, wird sie Åber Basepage und per
      (!nolink [shel_read]) Åbergeben, wobei die Nullbytes durch Leerstellen ersetzt
      werden, ansonsten besteht sie nur aus dem Byte mit dem Wert 127.
!end_itemize

Das Vorhandensein der zusÑtzlichen Features kann per (!link [appl_getinfo][%apgi_10])
(Opcode 10) erfragt werden. Die mit (*) gekennzeichneten Opcodes von shel_write
stehen z.Zt. nur in (!nolink [MagiC]) zur VerfÅgung.


!label shel_write und Single-TOS
(!B)Achtung:(!b) Startet man ein neuen AES-Prozeû unter Singel-TOS mit
(!nolink [shel_write])
wird dieser aber erst nach Beendigung des eigenen Prozesses gestartet.

!item [(!nolink [Return]) Value:]
Ein Fehler ist nur dann aufgetreten, wenn als Ergebnis 0 zurÅckgegeben wird.

!item [Availability:]
All (!nolink [AES]) versions.

!item [Group:]
Shell Library

!item [See Also:]
(!link [Binding] [Bindings for shel_write]) ~
(!link [Shutdown Mechanismus][Allgemeines zum Shutdown]) ~
Threads in MagiC

(!ende_liste)



!begin_node Bindings for shel_write
!ignore_index

(!begin_liste) [GEM-Arrays]

!item [C:]
int16_t shel_write ( int16_t sh_wdoex, int16_t sh_wisgr, int16_t sh_wiscr,
                  int8_t *sh_wpcmd, int8_t *sh_wptail );

!item [Binding:]
!begin_verbatim
int16_t shel_write (int16_t sh_wdoex, int16_t sh_wisgr,
                    int16_t sh_wiscr, int8_t *sh_wpcmd,
                    int8_t *sh_wptail)
{
   int_in[0]  = sh_wdoex;
   int_in[1]  = sh_wisgr;
   int_in[2]  = sh_wiscr;
   addr_in[0] = sh_wpcmd;
   addr_in[1] = sh_wptail;

   return ( crys_if(121) );
}
!end_verbatim

!item [GEM-Arrays:]
!begin_table [l l l]
Adresse !! Feldelement !! Belegung
!hline
control   !! control[0] !! 121   # Function Opcode
control+2 !! control[1] !! 3     # entry in int_in
control+4 !! control[2] !! 1     # entry in int_out
control+6 !! control[3] !! 2     # entry in addr_in
control+8 !! control[4] !! 0     # entry in addr_out
int_in    !! int_in[0]  !! sh_wdoex
int_in+2  !! int_in[1]  !! sh_wisgr
int_in+4  !! int_in[2]  !! sh_wiscr
addr_in   !! addr_in[0] !! sh_wpcmd
addr_in+4 !! addr_in[1] !! sh_wptail
int_out   !! int_out[0] !! Return-Wert
!end_table

(!ende_liste)
!end_node
!end_node

!else

!begin_node shel_write

(!begin_liste) [Beschreibung]

!item [Name:]
ØShell writeÆ - startet eine andere Applikation.

!item [AES-Nummer:]
121

!item [Deklaration:]
int16_t shel_write ( int16_t sh_wdoex, int16_t sh_wisgr, int16_t sh_wiscr,
                  int8_t *sh_wpcmd, int8_t *sh_wptail );

!item [Beschreibung:]
Die Funktion ermîglicht das Starten eines anderen Programms. Ab AES-Version
4.0 wurde diese Funktion stark erweitert. So lassen sich nun auch Aufgaben
wie ein Herunterfahren des Systems (Shutdown), ein Auflîsungswechsel,
AES-Broadcasting und andere Dinge realisieren.

Der Parameter (!I)sh_wdoex(!i) bestimmt die auszufÅhrende Aktion, die
restlichen Parameter sind im wesentlichen von (!I)sh_wdoex(!i) abhÑngig. Es
gilt:

!begin_xlist !short [sh_wdoe]
!item [sh_wdoex]
Bedeutung
!item [~]
~
!item [0]
(!B)Applikation starten(!b)
(!nl)
Der Wert des Parameters (!I)sh_wisgr(!i) (Starten im Grafikmodus, ja oder
nein) wird automatisch vom (!nolink [AES]) gesetzt, indem die File-Extension mit den
Inhalten der AES-Environmentvariablen GEMEXT, TOSEXT und ACCEXT verglichen
wird.
!item [1]
(!B)Applikation im GEM/TOS Modus starten(!b)
(!nl)
Der Parameter (!I)sh_wisgr(!i) legt dabei den Modus fest, in dem das
Programm gestartet werden soll. Es gilt:
!begin_xlist !short [sh_wisgr = 0:]
!item [sh_wisgr = 0:]
als TOS-Programm starten
!item [sh_wisgr = 1:]
als (!nolink [GEM])-Programm starten
!end_xlist
!item [2]
(!B)reserviert(!b)
!item [3]
(!B)Accessorie starten(!b)
(!nl)
Ein Programm soll als Accessorie gestartet werden.
!end_xlist

In den Parametern (!I)sh_wpcmd(!i) und (!I)sh_wptail(!i) sind dabei der Name
des zu startenden Programms bzw. ein Zeiger auf die Kommandozeile zu
Åbergeben. Als Default-Verzeichnis wird dabei das Verzeichnis gewÑhlt, in
dem sich das zu startende Programm befindet (Ausnahme: erweiterter Modus mit
gesetztem Bit-10, s.u.).

Die Funktion liefert die (!nolink [AES])-ID des gestarteten Prozesses zurÅck. Ein Wert
von 0 zeigt in diesem Zusammenhang einen Fehler an. öber den Parameter
(!I)sh_wiscr(!i) kann spezifiziert werden, ob (!B)Parameter per ARGV(!b) an
das gestartete Programm Åbergeben werden sollen. Es gilt:

sh_wiscr = 0: ARGV-Verfahren nicht benutzen (!nl)
sh_wiscr = 1: (!nolink [ARGV-Verfahren]) benutzen

!label Paralleles Starten von Programmen
Unter MagiC kann hingegen angegeben werden, ob ein Programm im
(!B)Single-Modus(!b) (oder parallel) gestartet werden soll. Es gilt:

sh_wiscr = 100  (!B)(Programm parallel ausfÅhren)(!b)
(!nl)
Die neue Applikation erbt alle Standardpfade und -dateien von der aktuellen
Applikation. Ein Fehlercode wird nur dann zurÅckgeliefert, falls bereits
beim Einrichten ein Speicherplatzmangel aufgetreten ist; eine Benachrichtung
beim Beenden der neuen Applikation (Death-of-Child) existiert nicht (*).

!label Single-Modus
sh_wiscr = 101  (!B)(Programm im Single-Modus ausfÅhren)(!b)
(!nl)
Dieser Modus entspricht (!I)sh_wiscr(!i) mit dem Wert 1, mit der Ausnahme,
daû vor Aufruf des Programms alle Applikationen auûer denjenigen mit ID-0
und ID-1 (SCRENMGR) eingefroren werden. Die Programme werden nach Beendigung
des Programms wieder aufgetaut, wenn dieses nicht seinerseits einen neuen
shel_write-Aufruf mit Singlemode Charakter ausgefÅhrt hat. (!B)Das genaue
Kochrezept fÅr den Single-Modus lautet:(!b)

!begin_itemize !short
!item sicherstellen, daû man die Applikation mit ID-0 ist.
!item Pfade und Laufwerk fÅr das neue Programm setzen.
!item shel_write (TRUE, sh_wisgr, 101, sh_wpcmd, sh_wptail);
!item wichtige Einstellungen in Datei/Shell-Puffer sichern.
!item appl_exit, v_clsvwk, Pterm0 ausfÅhren.
!end_itemize

Beachtet werden sollte noch, daû ab (!nolink [MagiC])-2 im Single-Modus die aktuellen
Pfade des Aufrufers an den Parent und damit an das neue Programm Åbergeben
werden. Die Pfade des Aufrufers sind anschlieûend zerstîrt, was aber
unkritisch ist, da dieser auf den shel_write i.a. ein Pterm folgen lÑût (*).

Im (!B)erweiterten Modus(!b), kann Åber spezielle Bits des Parameters
(!I)sh_wdoex(!i) das Starten von Programmen weiter spezifiziert werden. Das
Low-Byte bleibt dabei unangetastet, und fÅr das High-Byte gilt:

!begin_table [c|l]
sh_wdoex Bit !! Bedeutung
!hline
 8 !! Wert von Psetlimit
 9 !! Wert von Prenice
10 !! Default-Verzeichnis
11 !! Environment-String
12 !! reserviert
13 !! reserviert
14 !! reserviert
15 !! reserviert
!end_table

In diesem erweiterten Modus wird der Parameter (!I)sh_wpcmd(!i) als Zeiger
auf eine Menge von 32bit (Long-)Werten aufgefaût. Jedem der o.g. Bits ist
dabei ein Long-Wert zugewiesen, der gÅltig ist, wenn das entsprechende Bit
gesetzt ist. Die Menge der 32bit Werte ist folgendermaûen belegt:

!begin_xlist !short [Elemen]
!item [Element]
Bedeutung
!item [~]
~
!item [[0!]]
Zeiger auf den Namen des Programms
!item [[1!]]
Wert von Psetlimit (Bit-8)
!item [[2!]]
Wert von Prenice   (Bit-9)
!item [[3!]]
Zeiger auf das Default-Verzeichnis.
(!nl)
Ein Nullzeiger bedeutet in diesem Zusammenhang, daû als Default-Verzeichnis
dasjenige gewÑhlt wird, indem sich das zu startende Programm befindet.
(Bit-10)
!item [[4!]]
Zeiger auf das Environment der Applikation (Bit-11)
!end_xlist

(!B)Hinweis:(!b) Die Elemente [1],[2] und [3] werden bis (!nolink [MagiC])-3 ignoriert;
Element [1] wird jedoch ab MagiC-4 unterstÅtzt. Das Default-Verzeichnis wird
unter (!nolink [MagiC]) viel einfacher gesetzt, denn das neue Programm erbt alle Pfade
auf allen Laufwerken vom aufrufenden Programm. (!nl)
Bei Geneva wird nur Bit 8 beachtet.


(!B)In neueren (!nolink [AES])-Versionen stehen darÅber hinaus die folgenden Modi zur
VerfÅgung(!b).

!begin_xlist [sh_wdoe]
!item [sh_wdoex]
Bedeutung
!item [~]
~
!label Shutdown Modus
!item [4]
(!B)Shutdown-Modus setzen(!b)
(!nl)
Dieses Kommando versetzt das System in AbhÑngigkeit des Parameters
(!I)sh_wiscr(!i) in den Normal bzw. Shutdown Modus. Es gilt:

!begin_xlist !short [sh_wiscr]
!item [sh_wiscr]
Bedeutung
!item [~]
~
!label Shutdown abbrechen
!item [0]
(!B)Shutdown Sequenz abbrechen(!b)
(!nl)
Ein begonnener Shutdown kann nur von dem Prozess beendet werden, der diese
Sequenz auch gestartet hat.
!label Shutdown, partieller
!item [1]
(!B)Partieller Shutdown(!b)
(!nl)
Mit Ausnahme des Aufrufers werden alle Applikationen vom (!nolink [AES]) daraufhin
ÅberprÅft, ob sie die Meldung AP_TERM verstehen. Wenn dies der Fall ist,
schickt das (!nolink [AES]) die Meldungen (!nolink [AP_TERM]) bzw. AC_CLOSE an die
Programme bzw. Accessories. Der Aufrufer erhÑlt keine dieser Meldungen.
!label Shutdown, vollstÑndiger
!item [2]
(!B)VollstÑndiger Shutdown(!b)
(!nl)
Mit Ausnahme des Aufrufers werden alle Applikationen und Accessories vom
AES daraufhin ÅberprÅft, ob sie die Meldung AP_TERM verstehen. Wenn dies der
Fall ist, schickt das (!nolink [AES]) die Meldungen (!nolink [AP_TERM]) bzw.
(!nolink [AC_CLOSE]) an die
Programme bzw. Accessories. Accessories erhalten die (!nolink [AP_TERM]) Nachricht
zusÑtzlich nach Erhalt der (!nolink [AC_CLOSE]) Message. Der Aufrufer erhÑlt keine
dieser Meldungen.
!end_xlist

In N.AES gibt es einen erweiterten Aufruf: (!nl)
shel_write(4, shutart, 0, &ignorant, NULL);

(!I)ignorant(!i) ist hierbei ein Integer, dessen Adresse als vierter Parameter des
shel_write-Aufrufs Åbergeben wird. Im Fehlerfall ist der RÅckgabewert der
Funktion shel_write wie bisher 0, zusÑtzlich wird jedoch in (!I)ignorant(!i) die Applikations-ID
(apid) der Applikation hinterlegt, die AP_TERM nicht verstanden hat
bzw. -1, wenn bereits ein Shutdown lÑuft oder -2, wenn ungÅltige Parameter
Åbergeben wurden.

!label Auflîsungswechsel
!item [5]
(!B)Auflîsungswechsel(!b)
(!nl)
Die Applikation fordert das (!nolink [AES]) auf, die Auflîsung zu wechseln. Falls das
(!nolink [AES]) dem Wechsel zustimmt, versucht es, das System herunterzufahren
(Shutdown). Die aktiven Applikationen kînnen sich nun entweder beenden,
oder durch eine AP_TFAIL Nachricht dem AES mitteilen, daû sie hierzu nicht
in der Lage sind. Die Parameter (!I)sh_wisgr(!i) und (!I)sh_wiscr(!i) sind
dabei voneinander abhÑngig. Es gilt:

!begin_xlist !short [sh_wisc]
!item [sh_wiscr]
Bedeutung
!item [~]
~
!item [0]
Der Parameter (!I)sh_wisgr(!i) ist die ID des physikalischen GerÑtes, auf
dem der Open-Workstation Aufruf des VDI ausgefÅhrt wird. Die aktuelle
physikalische GerÑtenummer kann wie Åblich per Getrez() + 2 ermittelt
werden; es stehen folgende Werte zur VerfÅgung:
!begin_table [l l l r]
2 !! = !! ST-Low    !!  (320*200)
3 !! = !! ST-Medium !!  (640*200)
4 !! = !! ST-High   !!  (640*400)
6 !! = !! TT-Medium !!  (640*480)
8 !! = !! TT-High   !! (1280*960)
9 !! = !! TT-Low    !!  (320*480)
!end_table
!item [1]
Der Parameter (!I)sh_wisgr(!i) ist das int16_t fÅr den Video-Modus des Falcon.
!item [>2]
fÅr zukÅnftige Zwecke reserviert
!end_xlist

In N.AES gibt es einen erweiterten Aufruf: (!nl)
shel_write(5, vmode, falconflag, &ignorant, NULL); (!nl)
Da ein Auflîsungswechsel intern zunÑchst immer einen vollstÑndigen Shutdown
startet, kann es auch hier geschehen, daû nicht alle Anwendungen AP_TERM
verstehen und der Auflîsungswechsel somit frÅhzeitig fehlschlÑgt. Analog zur
obigen Modus-4-Erweiterung wird auch hier die Applikations-ID eines
VerstÑndnislosen in (!I)ignorant(!i) hinterlegt, eine -1, wenn bereits ein (!nolink [Shutdown])
lÑuft oder -2, wenn fehlerhafte Parameter (z.B. unerlaubte Auflîsungen)
Åbergeben wurden.

!item [6]
(!B)unbekannt(!b)

!label Broadcasting des AES
!label AES-Broadcasting
!item [7]
(!B)AES-Broadcasting(!b)
(!nl)
Die Applikation mîchte eine Nachricht an alle anderen im System vorhandenen
Applikationen schicken. Als EmpfÑnger ausgenommen sind nur das AES, der
Screen-Manager, sowie der Absender der Nachricht selbst.

Der Parameter (!I)sh_wpcmd(!i) ist ein Zeiger auf einen 16 Bytes groûen
Nachrichtenpuffer, der die zu sendenden Daten enthÑlt.

!label AES-Environment manipulieren
!label Environment des AES manipulieren
!item [8]
(!B)Manipulation des (!nolink [AES])-Environments(!b)
(!nl)
Dieses Kommando erlaubt die Modifikation des AES-Environments. Der Parameter
(!I)sh_wisgr(!i) beschreibt die gewÅnschte Aktion. Es gilt:

!begin_xlist !short [sh_wisg]
!item [sh_wisgr]
Bedeutung
!item [~]
~
!item [0]
(!B)Grîûe des Environment-Puffers erfragen(!b). Diese wird als
Funktionsergebnis zurÅckgeliefert.
!item [1]
(!B)EinfÅgen/Entfernen von Strings(!b). Der Parameter (!I)sh_wpcmd(!i) ist
ein Zeiger auf den Environment-String. Die Syntax zum EinfÅgen bzw.
Entfernen lautet 'NEW=STRING\0' bzw. 'NEW=\0'.
!item [2]
(!B)Inhalt des Environment-Puffers kopieren(!b). Der Parameter
(!I)sh_wpcmd(!i) ist ein Zeiger auf den aufnehmenden Puffer, der eine Grîûe
von (!I)sh_wiscr(!i) Bytes besitzt. Die Funktion liefert die Anzahl der
Bytes zurÅck, die nicht kopiert werden konnten.
!end_xlist

!item [9]
(!B)UnterstÅtzte Nachrichten anzeigen(!b)
(!nl)
Die Applikation teilt dem (!nolink [AES]) mit, welche (neuen) Nachrichten verstanden
werden. Dies geschieht Åber gesetzte Bits des Parameters (!I)sh_wisgr(!i).
!label NM_INHIBIT_HIDE
!begin_xlist !short [Bit 0:]
!item [Bit 0:]
AP_TERM
!item [Bit 1:]
NM_INHIBIT_HIDE (since XaAES 2005-01-16) (!nl)
SchÅtzt eine Application davor versteckt zu werden. NÅtzlich fÅr Desktop Utillity
wie Taskbar oder StartMe Up.
!end_xlist
Alle anderen Bits (2-15) sind z.Zt. nicht definiert.

!item [10]
(!B)Nachricht an (!nolink [AES]) senden(!b)
(!nl)
Die Applikation will eine Nachricht an das (!nolink [AES]) schicken. Der Parameter
(!I)sh_wpcmd(!i) ist ein Zeiger auf den 16 Bytes groûen Nachrichtenpuffer.

!begin_description
!item [Geneva]
A program can cause a windowed dialog to scroll by sending a WM_ARROWED
message to Geneva. Example:
!begin_verbatim
int16_t msg[8];

msg[0] = WM_ARROWED;
msg[3] = window_handle;
msg[4] = WA_UPPAGE;
shel_write( SHW_SENDTOAES, 0, 0, (int8_t *)msg, 0L );
!end_verbatim
!end_description

!label Threads, Erzeugen von
!item [20]
(!B)Neuen Thread erzeugen(!b)
(!nl)
Mit diesem Opcode kann die Applikation einen neuen Thread erzeugen. Dabei
gilt:

!begin_xlist !short [Paramete]
!item [Parameter]
Bedeutung
!item [~]
~
!item [sh_wisgr]
!begin_xlist !short [0 =]
!item [0 =]
Starte Programm im VT52 Fenster der Applikation, falls eines geîffnet ist.
!item [1 =]
îffne kein neues Fenster
!item [2 =]
îffne neues VT52-Fenster
!end_xlist
!item [sh_wiscr]
0
!item [sh_wpcmd]
Zeiger auf THREADINFO-Struktur.
!item [sh_wptail]
Parameter vom Typ (void *) fÅr die Thread-Funktion.
!end_xlist

Bei einem erfolgreichen Aufruf wird als Ergebnis die Applikations-ID des
neuen Threads zurÅckgeliefert (*).

!label Threads, Beenden von
!item [21]
(!B)Thread beenden(!b)
(!nl)
Mit diesem Opcode kann sich ein Thread selbst beenden. Dazu setzt man die
Parameter (!I)sh_wisgr(!i) (!I)sh_wiscr(!i) und (!I)sh_wptail(!i) auf die
Werte 0 bzw. NULL; Åber (!I)sh_wpcmd(!i) kann ein zurÅckzuliefernder
Fehlercode angegeben werden.

Normalerweise ist ein AusfÅhren dieser Funktion nicht notwendig, da sich der
Thread automatisch mit dem Ende seiner Prozedur (d.h. mit dem CPU-Befehl
RTS) selbst beendet. (!B)Wichtig:(!b) Wenn der Thread einen Pexec-Aufruf
durchgefÅhrt hat, so muss zuerst der laufende Prozess per Pterm beendet
werden, bevor sich der Thread beenden kann (*).

!item [22]
(!B)Thread terminieren(!b)
(!nl)
Mit diesem Opcode kann ein Thread auch vom Hauptprogramm beendet werden.
Dazu Åbergibt man im Parameter (!I)sh_wiscr(!i) die Applikations-ID des
Thread, und setzt die Åbrigen Parameter auf den Wert 0 bzw. NULL.

Normalerweise ist diese Funktion nicht notwendig, da mit dem Beenden des
Hauptprogramms automatisch auch alle zugehîrigen Threads beendet werden. Die
Funktion wurde erfolgreich ausgefÅhrt, wenn als Ergebnis der Wert 1
zurÅckgeliefert wird. Zu beachten ist jedoch, daû fÅr den Fall, daû der
Thread inzwischen ein Pexec ausgefÅhrt hat, nur dieses Programm per Pterm
(EBREAK) beendet wird; der Thread selbst ist erst dann beendet, wenn der
Aufrufer ein THR_EXIT empfangen hat (*).

!label XSHW_RUNANY
!item [224]
(!B)Run an application(!b) (Geneva since Update 004)
(!nl)
Run an application, letting Geneva determine the
type. This is identical to mode 0, except that the XSHD_FLAGS bit
of (!I)sw_doex(!i) can also be set (see below).

!label XSHW_RUNAPP
!item [225]
(!B)Run an application(!b) (Geneva since Update 004)
(!nl)
This is identical to mode 1,
except that the XSHD_FLAGS bit of (!I)sw_doex(!i) can also be set.

!label XSHW_RUNACC
!item [227]
(!B)Run a desk accessory.(!b) (Geneva since Update 004)
(!nl)
This is identical to mode 3, except that the XSHD_FLAGS bit of
(!I)sw_doex(!i) can also be set.

When XSHD_FLAGS (1<<15) is added to the (!I)sw_doex(!i), this means that the
last longword of the SHWRCMD passed in the (!I)sh_wpcmd(!i) parameter contains
the Geneva program flags to use when executing the application. (!nl)
It is strongly recommended that a program using XSHD_FLAGS inquire the
current flags for the application and only change the ones it needs to
change, rather than making most of the flags zero or some other random
value. See the x_appl_flags section, below, for an example.

!end_xlist

(!B)Hinweis:(!b) Ab MagiC-3 stehen die folgenden Besonderheiten zur
VerfÅgung:

!begin_itemize
!item Wird in (!I)sh_wptail(!i) eine Zeichenkette Åbergeben, die mit dem
      Wert 255 beginnt und mit '\0' abgeschlossen ist, wird die tatsÑchliche
      LÑnge der Kommandozeile vom AES bestimmt und in ganzer LÑnge ans DOS
      weitergereicht. Das DOS konstruiert hieraus einen ARGV-Parameter im
      Environment. Ist die Kommandozeile kÅrzer als 127 Bytes, wird sie Åber
      Basepage und per shel_read Åbergeben, ansonsten besteht sie nur aus
      dem Byte mit dem Wert 127.
!item Wird in (!I)sh_wptail(!i) eine Zeichenkette Åbergeben, die mit dem
      Wert 254 beginnt, erwartet das AES dahinter die Zeichenkette
      "ARGV=irgendwas" und eine durch '\0' getrennte und durch "\0\0"
      abgeschlossene Liste von Parametern. Diese wird vollstÑndig dem DOS
      Åbergeben, das daraus einen ARGV-Parameter konstruiert. Ist die
      Kommandozeile kÅrzer als 127 Bytes, wird sie Åber Basepage und per
      (!nolink [shel_read]) Åbergeben, wobei die Nullbytes durch Leerstellen ersetzt
      werden, ansonsten besteht sie nur aus dem Byte mit dem Wert 127.
!end_itemize

Das Vorhandensein der zusÑtzlichen Features kann per (!link [appl_getinfo][%apgi_10])
(Opcode 10) erfragt werden. Die mit (*) gekennzeichneten Opcodes von shel_write
stehen z.Zt. nur in (!nolink [MagiC]) zur VerfÅgung.


!label shel_write und Single-TOS
(!B)Achtung:(!b) Startet man ein neuen AES-Prozeû unter Singel-TOS mit
(!nolink [shel_write])
wird dieser aber erst nach Beendigung des eigenen Prozesses gestartet.

!item [Ergebnis:]
Ein Fehler ist nur dann aufgetreten, wenn als Ergebnis 0 zurÅckgegeben wird.

!item [VerfÅgbar:]
In allen (!nolink [AES]) Versionen.

!item [Gruppe:]
(!link [Shell-Kommunikation][Shellfunktionen])

!item [Querverweis:]
(!link [Binding] [Bindings fÅr shel_write]) ~
(!link [Shutdown Mechanismus][Allgemeines zum Shutdown]) ~
Threads in MagiC

(!ende_liste)



!begin_node Bindings fÅr shel_write
!ignore_index

(!begin_liste) [GEM-Arrays]

!item [C:]
int16_t shel_write ( int16_t sh_wdoex, int16_t sh_wisgr, int16_t sh_wiscr,
                  int8_t *sh_wpcmd, int8_t *sh_wptail );

!item [Umsetzung:]
!begin_verbatim
int16_t shel_write (int16_t sh_wdoex, int16_t sh_wisgr,
                    int16_t sh_wiscr, int8_t *sh_wpcmd,
                    int8_t *sh_wptail)
{
   int_in[0]  = sh_wdoex;
   int_in[1]  = sh_wisgr;
   int_in[2]  = sh_wiscr;
   addr_in[0] = sh_wpcmd;
   addr_in[1] = sh_wptail;

   return ( crys_if(121) );
}
!end_verbatim

!item [GEM-Arrays:]
!begin_table [l l l]
Adresse !! Feldelement !! Belegung
!hline
control   !! control[0] !! 121   # Opcode der Funktion
control+2 !! control[1] !! 3     # EintrÑge in int_in
control+4 !! control[2] !! 1     # EintrÑge in int_out
control+6 !! control[3] !! 2     # EintrÑge in addr_in
control+8 !! control[4] !! 0     # EintrÑge in addr_out
int_in    !! int_in[0]  !! sh_wdoex
int_in+2  !! int_in[1]  !! sh_wisgr
int_in+4  !! int_in[2]  !! sh_wiscr
addr_in   !! addr_in[0] !! sh_wpcmd
addr_in+4 !! addr_in[1] !! sh_wptail
int_out   !! int_out[0] !! Return-Wert
!end_table

(!ende_liste)
!end_node
!end_node

!endif
